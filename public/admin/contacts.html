<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contacts - Kodara Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/css/styles.css" />
  <link rel="icon" href="/image/Kodara logo1.png" type="image/png" />
  <link rel="apple-touch-icon" href="/image/Kodara logo1.png" />
</head>
<body>
  <header class="site-header">
    <div class="container nav">
      <div class="logo"><a href="/"><img src="/image/Kodara logo.png" alt="Kodara-HQ logo" /></a></div>
      <nav>
        <a href="/">Public Site</a>
        <a href="/admin/" class="active">Admin</a>
      </nav>
    </div>
  </header>

  <main class="auth">
    <section class="section">
      <div class="container">
        <div class="page-header">
          <h1>üìß Contact Management</h1>
          <p class="subtitle">View and manage incoming contact messages</p>
        </div>

        <div class="admin-grid">
          <aside class="card" id="sidebar">
            <h3>üöÄ Admin Dashboard</h3>
            <p class="muted">Welcome to Kodara-HQ Admin</p>
            <nav class="stack" style="margin-top:10px; display: flex; flex-direction: column; gap: 8px;">
              <a href="/admin/projects.html" class="btn btn-secondary" style="text-align: left; justify-content: flex-start;">üìÅ Projects</a>
              <a href="/admin/contacts.html" class="btn btn-secondary active" style="text-align: left; justify-content: flex-start;">üìß Contacts</a>
              <a href="/admin/subscriptions.html" class="btn btn-secondary" style="text-align: left; justify-content: flex-start;">üìã Subscriptions</a>
              <a href="/admin/payments.html" class="btn btn-secondary" style="text-align: left; justify-content: flex-start;">üí≥ Payments</a>
            </nav>
          </aside>

          <section id="content">
            <div class="card panel">
              <div class="section-header">
                <h3>üìä Contact Overview</h3>
                <div class="stats-grid">
                  <div class="stat-card">
                    <div class="stat-number" id="totalContacts">-</div>
                    <div class="stat-label">Total Contacts</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-number" id="newContacts">-</div>
                    <div class="stat-label">New Today</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-number" id="avgResponse">-</div>
                    <div class="stat-label">Avg Response Time</div>
                  </div>
                </div>
              </div>

              <div class="section-header">
                <h3>üîç Filter & Search</h3>
                <div class="filter-controls">
                  <input type="text" id="searchContacts" placeholder="Search by name, email, or message..." class="search-input" />
                  <select id="filterService" class="filter-select">
                    <option value="">All Services</option>
                    <option value="web">Web Development</option>
                    <option value="mobile">Mobile App</option>
                    <option value="design">UI/UX Design</option>
                    <option value="software">Software</option>
                    <option value="consulting">Consulting</option>
                  </select>
                  <select id="filterBudget" class="filter-select">
                    <option value="">All Budgets</option>
                    <option value="under-5k">Under $5K</option>
                    <option value="5k-10k">$5K - $10K</option>
                    <option value="10k-25k">$10K - $25K</option>
                    <option value="25k-50k">$25K - $50K</option>
                    <option value="over-50k">Over $50K</option>
                  </select>
                  <select id="filterTimeline" class="filter-select">
                    <option value="">All Timelines</option>
                    <option value="1-2-weeks">1-2 Weeks</option>
                    <option value="1-month">1 Month</option>
                    <option value="2-3-months">2-3 Months</option>
                    <option value="3-6-months">3-6 Months</option>
                    <option value="6-months-plus">6+ Months</option>
                  </select>
                </div>
              </div>

              <div class="table-container">
                <table id="contactsTable" class="table">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Email</th>
                      <th>Service</th>
                      <th>Budget</th>
                      <th>Timeline</th>
                      <th>Date</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="contactsTableBody">
                    <!-- Contacts will be loaded here -->
                  </tbody>
                </table>
                <p id="contactsStatus" class="status"></p>
              </div>
            </div>
          </section>
        </div>
      </div>
    </section>
  </main>

  <!-- Contact Detail Modal -->
  <div id="contactModal" class="modal-overlay" style="display: none;">
    <div class="modal">
      <h3 id="modalTitle">Contact Details</h3>
      <div id="modalContent"></div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal()">Close</button>
        <button class="btn" onclick="replyToContact()">üìß Reply</button>
      </div>
    </div>
  </div>

  <script>
    let contacts = [];
    let filteredContacts = [];

    // DOM elements
    const contactsTable = document.getElementById('contactsTable');
    const contactsTableBody = document.getElementById('contactsTableBody');
    const contactsStatus = document.getElementById('contactsStatus');
    const searchInput = document.getElementById('searchContacts');
    const filterService = document.getElementById('filterService');
    const filterBudget = document.getElementById('filterBudget');
    const filterTimeline = document.getElementById('filterTimeline');

    // Event listeners
    searchInput.addEventListener('input', filterContacts);
    filterService.addEventListener('change', filterContacts);
    filterBudget.addEventListener('change', filterContacts);
    filterTimeline.addEventListener('change', filterContacts);

    // Load contacts on page load
    loadContacts();

    async function loadContacts() {
      contactsStatus.textContent = 'Loading contacts...';
      contactsStatus.className = 'status';
      
      try {
        const res = await fetch('/api/admin/contacts');
        const items = await res.json();
        
        if (!res.ok) throw new Error(items.error || 'Failed to load contacts');
        
        contacts = items;
        filteredContacts = [...contacts];
        renderContacts();
        updateStats();
        contactsStatus.textContent = '';
        
      } catch(err) {
        contactsStatus.textContent = `‚ùå ${err.message}`;
        contactsStatus.className = 'status error';
      }
    }

    function renderContacts() {
      if (filteredContacts.length === 0) {
        contactsTableBody.innerHTML = '<tr><td colspan="7" class="text-center">No contacts found</td></tr>';
        return;
      }

      contactsTableBody.innerHTML = filteredContacts.map(c => `
        <tr>
          <td><strong>${c.name || 'N/A'}</strong></td>
          <td><a href="mailto:${c.email}" class="email-link">${c.email || 'N/A'}</a></td>
          <td><span class="service-badge">${c.service || 'Not specified'}</span></td>
          <td><span class="budget-badge">${c.budget || 'Not specified'}</span></td>
          <td><span class="timeline-badge">${c.timeline || 'Not specified'}</span></td>
          <td>${formatDate(c.dateSubmitted)}</td>
          <td>
            <button onclick="viewContact(${c.id})" class="btn btn-secondary btn-sm">üëÅÔ∏è View</button>
            <button onclick="deleteContact(${c.id})" class="btn del btn-sm">üóëÔ∏è Delete</button>
          </td>
        </tr>
      `).join('');
    }

    function filterContacts() {
      const searchTerm = searchInput.value.toLowerCase();
      const serviceFilter = filterService.value;
      const budgetFilter = filterBudget.value;
      const timelineFilter = filterTimeline.value;
      
      filteredContacts = contacts.filter(contact => {
        const matchesSearch = (contact.name && contact.name.toLowerCase().includes(searchTerm)) || 
                            (contact.email && contact.email.toLowerCase().includes(searchTerm)) ||
                            (contact.message && contact.message.toLowerCase().includes(searchTerm));
        const matchesService = !serviceFilter || contact.service === serviceFilter;
        const matchesBudget = !budgetFilter || contact.budget === budgetFilter;
        const matchesTimeline = !timelineFilter || contact.timeline === timelineFilter;
        
        return matchesSearch && matchesService && matchesBudget && matchesTimeline;
      });
      
      renderContacts();
    }

    function updateStats() {
      const total = contacts.length;
      const today = new Date().toDateString();
      const newToday = contacts.filter(c => new Date(c.dateSubmitted).toDateString() === today).length;
      
      document.getElementById('totalContacts').textContent = total;
      document.getElementById('newContacts').textContent = newToday;
      document.getElementById('avgResponse').textContent = '24h'; // Placeholder
    }

    function viewContact(id) {
      const contact = contacts.find(c => c.id === id);
      if (!contact) return;
      
      document.getElementById('modalTitle').textContent = `Contact from ${contact.name}`;
      document.getElementById('modalContent').innerHTML = `
        <div class="contact-details">
          <div class="detail-row">
            <strong>Name:</strong> ${contact.name || 'N/A'}
          </div>
          <div class="detail-row">
            <strong>Email:</strong> <a href="mailto:${contact.email}">${contact.email || 'N/A'}</a>
          </div>
          <div class="detail-row">
            <strong>Phone:</strong> ${contact.phone || 'N/A'}
          </div>
          <div class="detail-row">
            <strong>Company:</strong> ${contact.company || 'N/A'}
          </div>
          <div class="detail-row">
            <strong>Service:</strong> <span class="service-badge">${contact.service || 'Not specified'}</span>
          </div>
          <div class="detail-row">
            <strong>Budget:</strong> <span class="budget-badge">${contact.budget || 'Not specified'}</span>
          </div>
          <div class="detail-row">
            <strong>Timeline:</strong> <span class="timeline-badge">${contact.timeline || 'Not specified'}</span>
          </div>
          <div class="detail-row">
            <strong>Enquiry Type:</strong> ${contact.enquiryType || 'N/A'}
          </div>
          <div class="detail-row">
            <strong>Date:</strong> ${formatDate(contact.dateSubmitted)}
          </div>
          <div class="detail-row">
            <strong>Message:</strong>
            <div class="message-content">${contact.message || 'N/A'}</div>
          </div>
        </div>
      `;
      
      document.getElementById('contactModal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('contactModal').style.display = 'none';
    }

    function replyToContact() {
      const contact = contacts.find(c => c.id === parseInt(document.getElementById('modalTitle').textContent.match(/Contact from (.+)/)?.[1]));
      if (contact && contact.email) {
        window.open(`mailto:${contact.email}?subject=Re: Your enquiry to Kodara-HQ`, '_blank');
      }
    }

    async function deleteContact(id) {
      if (!confirm('Are you sure you want to delete this contact?')) return;
      
      try {
        // Note: This would require a DELETE endpoint for contacts
        // For now, we'll just remove from the local array
        contacts = contacts.filter(c => c.id !== id);
        filteredContacts = filteredContacts.filter(c => c.id !== id);
        renderContacts();
        updateStats();
        
        contactsStatus.textContent = '‚úÖ Contact deleted successfully!';
        contactsStatus.className = 'status success';
        setTimeout(() => {
          contactsStatus.textContent = '';
          contactsStatus.className = 'status';
        }, 3000);
        
      } catch(err) {
        contactsStatus.textContent = `‚ùå ${err.message}`;
        contactsStatus.className = 'status error';
      }
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    // Close modal when clicking outside
    document.getElementById('contactModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeModal();
      }
    });
  </script>
</body>
</html>
