<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Subscriptions - Kodara Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/css/styles.css" />
  <link rel="icon" href="/image/Kodara logo1.png" type="image/png" />
  <link rel="apple-touch-icon" href="/image/Kodara logo1.png" />
</head>
<body>
  <header class="site-header">
    <div class="container nav">
      <div class="logo"><a href="/"><img src="/image/Kodara logo.png" alt="Kodara-HQ logo" /></a></div>
      <nav>
        <a href="/">Public Site</a>
        <a href="/admin/" class="active">Admin</a>
      </nav>
    </div>
  </header>

  <main class="auth">
    <section class="section">
      <div class="container">
        <div class="page-header">
          <h1>📋 Subscription Management</h1>
          <p class="subtitle">Manage email subscriptions and newsletter lists</p>
        </div>

        <div class="admin-grid">
          <aside class="card" id="sidebar">
            <h3>🚀 Admin Dashboard</h3>
            <p class="muted">Welcome to Kodara-HQ Admin</p>
            <nav class="stack" style="margin-top:10px; display: flex; flex-direction: column; gap: 8px;">
              <a href="/admin/projects.html" class="btn btn-secondary" style="text-align: left; justify-content: flex-start;">📁 Projects</a>
              <a href="/admin/contacts.html" class="btn btn-secondary" style="text-align: left; justify-content: flex-start;">📧 Contacts</a>
              <a href="/admin/subscriptions.html" class="btn btn-secondary active" style="text-align: left; justify-content: flex-start;">📋 Subscriptions</a>
              <a href="/admin/payments.html" class="btn btn-secondary" style="text-align: left; justify-content: flex-start;">💳 Payments</a>
            </nav>
          </aside>

          <section id="content">
            <div class="card panel">
              <div class="section-header">
                <h3>📊 Subscription Overview</h3>
                <div class="stats-grid">
                  <div class="stat-card">
                    <div class="stat-number" id="totalSubscriptions">-</div>
                    <div class="stat-label">Total Subscribers</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-number" id="newThisMonth">-</div>
                    <div class="stat-label">New This Month</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-number" id="growthRate">-</div>
                    <div class="stat-label">Growth Rate</div>
                  </div>
                </div>
              </div>

              <div class="section-header">
                <h3>📧 Newsletter Tools</h3>
                <div class="newsletter-controls">
                  <button class="btn" onclick="exportSubscribers()">📥 Export List</button>
                  <button class="btn btn-secondary" onclick="showNewsletterModal()">📨 Send Newsletter</button>
                  <button class="btn btn-secondary" onclick="showBulkActions()">⚡ Bulk Actions</button>
                </div>
              </div>

              <div class="section-header">
                <h3>🔍 Filter & Search</h3>
                <div class="filter-controls">
                  <input type="text" id="searchSubscriptions" placeholder="Search by email..." class="search-input" />
                  <select id="filterDate" class="filter-select">
                    <option value="">All Time</option>
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="quarter">This Quarter</option>
                    <option value="year">This Year</option>
                  </select>
                  <button class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
                </div>
              </div>

              <div class="table-container">
                <table id="subscriptionsTable" class="table">
                  <thead>
                    <tr>
                      <th><input type="checkbox" id="selectAll" /></th>
                      <th>Email</th>
                      <th>Date Subscribed</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="subscriptionsTableBody">
                    <!-- Subscriptions will be loaded here -->
                  </tbody>
                </table>
                <p id="subscriptionsStatus" class="status"></p>
              </div>
            </div>
          </section>
        </div>
      </div>
    </section>
  </main>

  <!-- Newsletter Modal -->
  <div id="newsletterModal" class="modal-overlay" style="display: none;">
    <div class="modal">
      <h3>📨 Send Newsletter</h3>
      <form id="newsletterForm" class="stack">
        <label>Subject<input type="text" name="subject" required placeholder="Newsletter subject..." /></label>
        <label>Message<textarea name="message" required placeholder="Your newsletter content..." rows="6"></textarea></label>
        <div class="form-actions">
          <button type="submit" class="btn">📤 Send Newsletter</button>
          <button type="button" class="btn btn-secondary" onclick="closeNewsletterModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Bulk Actions Modal -->
  <div id="bulkActionsModal" class="modal-overlay" style="display: none;">
    <div class="modal">
      <h3>⚡ Bulk Actions</h3>
      <div class="bulk-actions">
        <button class="btn btn-secondary" onclick="bulkDelete()">🗑️ Delete Selected</button>
        <button class="btn btn-secondary" onclick="bulkExport()">📥 Export Selected</button>
        <button class="btn btn-secondary" onclick="bulkUnsubscribe()">📧 Unsubscribe Selected</button>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeBulkActions()">Close</button>
      </div>
    </div>
  </div>

  <script>
    let subscriptions = [];
    let filteredSubscriptions = [];
    let selectedSubscriptions = new Set();

    // DOM elements
    const subscriptionsTable = document.getElementById('subscriptionsTable');
    const subscriptionsTableBody = document.getElementById('subscriptionsTableBody');
    const subscriptionsStatus = document.getElementById('subscriptionsStatus');
    const searchInput = document.getElementById('searchSubscriptions');
    const filterDate = document.getElementById('filterDate');
    const selectAll = document.getElementById('selectAll');

    // Event listeners
    searchInput.addEventListener('input', filterSubscriptions);
    filterDate.addEventListener('change', filterSubscriptions);
    selectAll.addEventListener('change', toggleSelectAll);

    // Load subscriptions on page load
    loadSubscriptions();

    async function loadSubscriptions() {
      subscriptionsStatus.textContent = 'Loading subscriptions...';
      subscriptionsStatus.className = 'status';
      
      try {
        const res = await fetch('/api/admin/subscriptions');
        const items = await res.json();
        
        if (!res.ok) throw new Error(items.error || 'Failed to load subscriptions');
        
        subscriptions = items;
        filteredSubscriptions = [...subscriptions];
        renderSubscriptions();
        updateStats();
        subscriptionsStatus.textContent = '';
        
      } catch(err) {
        subscriptionsStatus.textContent = `❌ ${err.message}`;
        subscriptionsStatus.className = 'status error';
      }
    }

    function renderSubscriptions() {
      if (filteredSubscriptions.length === 0) {
        subscriptionsTableBody.innerHTML = '<tr><td colspan="5" class="text-center">No subscriptions found</td></tr>';
        return;
      }

      subscriptionsTableBody.innerHTML = filteredSubscriptions.map(s => `
        <tr>
          <td><input type="checkbox" class="subscription-checkbox" value="${s.id}" ${selectedSubscriptions.has(s.id) ? 'checked' : ''} /></td>
          <td><a href="mailto:${s.email}" class="email-link">${s.email}</a></td>
          <td>${formatDate(s.dateSubscribed)}</td>
          <td><span class="status-badge active">Active</span></td>
          <td>
            <button onclick="unsubscribeSingle(${s.id})" class="btn btn-secondary btn-sm">📧 Unsubscribe</button>
            <button onclick="deleteSubscription(${s.id})" class="btn del btn-sm">🗑️ Delete</button>
          </td>
        </tr>
      `).join('');

      // Add event listeners to checkboxes
      document.querySelectorAll('.subscription-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedSubscriptions);
      });
    }

    function filterSubscriptions() {
      const searchTerm = searchInput.value.toLowerCase();
      const dateFilter = filterDate.value;
      
      filteredSubscriptions = subscriptions.filter(subscription => {
        const matchesSearch = subscription.email.toLowerCase().includes(searchTerm);
        const matchesDate = filterByDate(subscription.dateSubscribed, dateFilter);
        
        return matchesSearch && matchesDate;
      });
      
      renderSubscriptions();
    }

    function filterByDate(dateString, filter) {
      if (!filter) return true;
      
      const date = new Date(dateString);
      const now = new Date();
      
      switch(filter) {
        case 'today':
          return date.toDateString() === now.toDateString();
        case 'week':
          const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
          return date >= weekAgo;
        case 'month':
          return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
        case 'quarter':
          const quarter = Math.floor(now.getMonth() / 3);
          const subscriptionQuarter = Math.floor(date.getMonth() / 3);
          return subscriptionQuarter === quarter && date.getFullYear() === now.getFullYear();
        case 'year':
          return date.getFullYear() === now.getFullYear();
        default:
          return true;
      }
    }

    function updateStats() {
      const total = subscriptions.length;
      const now = new Date();
      const thisMonth = subscriptions.filter(s => {
        const date = new Date(s.dateSubscribed);
        return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
      }).length;
      
      const lastMonth = subscriptions.filter(s => {
        const date = new Date(s.dateSubscribed);
        const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        return date >= lastMonthDate && date < new Date(now.getFullYear(), now.getMonth(), 1);
      }).length;
      
      const growthRate = lastMonth > 0 ? ((thisMonth - lastMonth) / lastMonth * 100).toFixed(1) : 0;
      
      document.getElementById('totalSubscriptions').textContent = total;
      document.getElementById('newThisMonth').textContent = thisMonth;
      document.getElementById('growthRate').textContent = `${growthRate}%`;
    }

    function toggleSelectAll() {
      const checkboxes = document.querySelectorAll('.subscription-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
        if (selectAll.checked) {
          selectedSubscriptions.add(parseInt(checkbox.value));
        } else {
          selectedSubscriptions.delete(parseInt(checkbox.value));
        }
      });
    }

    function updateSelectedSubscriptions() {
      selectedSubscriptions.clear();
      document.querySelectorAll('.subscription-checkbox:checked').forEach(checkbox => {
        selectedSubscriptions.add(parseInt(checkbox.value));
      });
      
      // Update select all checkbox
      const totalCheckboxes = document.querySelectorAll('.subscription-checkbox').length;
      const checkedCheckboxes = selectedSubscriptions.size;
      selectAll.checked = checkedCheckboxes === totalCheckboxes;
      selectAll.indeterminate = checkedCheckboxes > 0 && checkedCheckboxes < totalCheckboxes;
    }

    function exportSubscribers() {
      const csvContent = "data:text/csv;charset=utf-8," + 
        "Email,Date Subscribed\n" +
        subscriptions.map(s => `${s.email},${s.dateSubscribed}`).join("\n");
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "subscribers.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function showNewsletterModal() {
      document.getElementById('newsletterModal').style.display = 'flex';
    }

    function closeNewsletterModal() {
      document.getElementById('newsletterModal').style.display = 'none';
    }

    function showBulkActions() {
      if (selectedSubscriptions.size === 0) {
        alert('Please select subscriptions first');
        return;
      }
      document.getElementById('bulkActionsModal').style.display = 'flex';
    }

    function closeBulkActions() {
      document.getElementById('bulkActionsModal').style.display = 'none';
    }

    function bulkDelete() {
      if (confirm(`Are you sure you want to delete ${selectedSubscriptions.size} subscriptions?`)) {
        // Note: This would require a bulk DELETE endpoint
        subscriptions = subscriptions.filter(s => !selectedSubscriptions.has(s.id));
        filteredSubscriptions = filteredSubscriptions.filter(s => !selectedSubscriptions.has(s.id));
        selectedSubscriptions.clear();
        renderSubscriptions();
        updateStats();
        closeBulkActions();
        
        subscriptionsStatus.textContent = '✅ Bulk delete completed!';
        subscriptionsStatus.className = 'status success';
        setTimeout(() => {
          subscriptionsStatus.textContent = '';
          subscriptionsStatus.className = 'status';
        }, 3000);
      }
    }

    function bulkExport() {
      const selectedSubs = subscriptions.filter(s => selectedSubscriptions.has(s.id));
      const csvContent = "data:text/csv;charset=utf-8," + 
        "Email,Date Subscribed\n" +
        selectedSubs.map(s => `${s.email},${s.dateSubscribed}`).join("\n");
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "selected_subscribers.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      closeBulkActions();
    }

    function bulkUnsubscribe() {
      if (confirm(`Are you sure you want to unsubscribe ${selectedSubscriptions.size} subscribers?`)) {
        // Note: This would require a bulk UPDATE endpoint
        selectedSubscriptions.clear();
        closeBulkActions();
        
        subscriptionsStatus.textContent = '✅ Bulk unsubscribe completed!';
        subscriptionsStatus.className = 'status success';
        setTimeout(() => {
          subscriptionsStatus.textContent = '';
          subscriptionsStatus.className = 'status';
        }, 3000);
      }
    }

    async function deleteSubscription(id) {
      if (!confirm('Are you sure you want to delete this subscription?')) return;
      
      try {
        // Note: This would require a DELETE endpoint for subscriptions
        subscriptions = subscriptions.filter(s => s.id !== id);
        filteredSubscriptions = filteredSubscriptions.filter(s => s.id !== id);
        selectedSubscriptions.delete(id);
        renderSubscriptions();
        updateStats();
        
        subscriptionsStatus.textContent = '✅ Subscription deleted successfully!';
        subscriptionsStatus.className = 'status success';
        setTimeout(() => {
          subscriptionsStatus.textContent = '';
          subscriptionsStatus.className = 'status';
        }, 3000);
        
      } catch(err) {
        subscriptionsStatus.textContent = `❌ ${err.message}`;
        subscriptionsStatus.className = 'status error';
      }
    }

    function unsubscribeSingle(id) {
      if (!confirm('Are you sure you want to unsubscribe this subscriber?')) return;
      
      // Note: This would require an UPDATE endpoint for subscriptions
      subscriptionsStatus.textContent = '✅ Subscriber unsubscribed successfully!';
      subscriptionsStatus.className = 'status success';
      setTimeout(() => {
        subscriptionsStatus.textContent = '';
        subscriptionsStatus.className = 'status';
      }, 3000);
    }

    function clearFilters() {
      searchInput.value = '';
      filterDate.value = '';
      filterSubscriptions();
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    // Newsletter form submission
    document.getElementById('newsletterForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const subject = formData.get('subject');
      const message = formData.get('message');
      
      // Note: This would require a newsletter sending endpoint
      alert(`Newsletter "${subject}" would be sent to ${subscriptions.length} subscribers.`);
      closeNewsletterModal();
      this.reset();
    });

    // Close modals when clicking outside
    document.querySelectorAll('.modal-overlay').forEach(modal => {
      modal.addEventListener('click', function(e) {
        if (e.target === this) {
          this.style.display = 'none';
        }
      });
    });
  </script>
</body>
</html>
