<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Payments - Kodara Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/css/styles.css" />
  <link rel="icon" href="/image/Kodara logo1.png" type="image/png" />
  <link rel="apple-touch-icon" href="/image/Kodara logo1.png" />
</head>
<body>
  <header class="site-header">
    <div class="container nav">
      <div class="logo"><a href="/"><img src="/image/Kodara logo.png" alt="Kodara-HQ logo" /></a></div>
      <nav>
        <a href="/">Public Site</a>
        <a href="/admin/" class="active">Admin</a>
      </nav>
    </div>
  </header>

  <main class="auth">
    <section class="section">
      <div class="container">
        <div class="page-header">
          <h1>💳 Payment Management</h1>
          <p class="subtitle">Track and manage payment records and transactions</p>
        </div>

        <div class="admin-grid">
          <aside class="card" id="sidebar">
            <h3>🚀 Admin Dashboard</h3>
            <p class="muted">Welcome to Kodara-HQ Admin</p>
            <nav class="stack" style="margin-top:10px; display: flex; flex-direction: column; gap: 8px;">
              <a href="/admin/projects.html" class="btn btn-secondary" style="text-align: left; justify-content: flex-start;">📁 Projects</a>
              <a href="/admin/contacts.html" class="btn btn-secondary" style="text-align: left; justify-content: flex-start;">📧 Contacts</a>
              <a href="/admin/subscriptions.html" class="btn btn-secondary" style="text-align: left; justify-content: flex-start;">📋 Subscriptions</a>
              <a href="/admin/payments.html" class="btn btn-secondary active" style="text-align: left; justify-content: flex-start;">💳 Payments</a>
            </nav>
          </aside>

          <section id="content">
            <div class="card panel">
              <div class="section-header">
                <h3>📊 Financial Overview</h3>
                <div class="stats-grid">
                  <div class="stat-card">
                    <div class="stat-number" id="totalRevenue">-</div>
                    <div class="stat-label">Total Revenue</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-number" id="monthlyRevenue">-</div>
                    <div class="stat-label">This Month</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-number" id="pendingPayments">-</div>
                    <div class="stat-label">Pending</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-number" id="successfulPayments">-</div>
                    <div class="stat-label">Successful</div>
                  </div>
                </div>
              </div>

              <div class="section-header">
                <h3>📈 Revenue Chart</h3>
                <div class="chart-controls">
                  <select id="chartPeriod" class="filter-select">
                    <option value="7">Last 7 Days</option>
                    <option value="30" selected>Last 30 Days</option>
                    <option value="90">Last 90 Days</option>
                    <option value="365">Last Year</option>
                  </select>
                  <button class="btn btn-secondary" onclick="exportPayments()">📥 Export Data</button>
                </div>
                <div id="revenueChart" class="chart-container">
                  <div class="chart-placeholder">
                    <p>📊 Revenue chart will be displayed here</p>
                    <p class="muted">Select a time period to view trends</p>
                  </div>
                </div>
              </div>

              <div class="section-header">
                <h3>🔍 Filter & Search</h3>
                <div class="filter-controls">
                  <input type="text" id="searchPayments" placeholder="Search by name, email, or project..." class="search-input" />
                  <select id="filterStatus" class="filter-select">
                    <option value="">All Statuses</option>
                    <option value="pending">Pending</option>
                    <option value="succeeded">Succeeded</option>
                    <option value="failed">Failed</option>
                    <option value="canceled">Canceled</option>
                  </select>
                  <select id="filterCurrency" class="filter-select">
                    <option value="">All Currencies</option>
                    <option value="usd">USD</option>
                    <option value="eur">EUR</option>
                    <option value="gbp">GBP</option>
                    <option value="ghs">GHS</option>
                  </select>
                  <input type="date" id="filterStartDate" class="date-input" />
                  <input type="date" id="filterEndDate" class="date-input" />
                  <button class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
                </div>
              </div>

              <div class="table-container">
                <table id="paymentsTable" class="table">
                  <thead>
                    <tr>
                      <th>Customer</th>
                      <th>Project</th>
                      <th>Amount</th>
                      <th>Status</th>
                      <th>Date</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="paymentsTableBody">
                    <!-- Payments will be loaded here -->
                  </tbody>
                </table>
                <p id="paymentsStatus" class="status"></p>
              </div>
            </div>
          </section>
        </div>
      </div>
    </section>
  </main>

  <!-- Payment Detail Modal -->
  <div id="paymentModal" class="modal-overlay" style="display: none;">
    <div class="modal">
      <h3 id="modalTitle">Payment Details</h3>
      <div id="modalContent"></div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal()">Close</button>
        <button class="btn" onclick="refundPayment()">💸 Refund</button>
      </div>
    </div>
  </div>

  <script>
    let payments = [];
    let filteredPayments = [];

    // DOM elements
    const paymentsTable = document.getElementById('paymentsTable');
    const paymentsTableBody = document.getElementById('paymentsTableBody');
    const paymentsStatus = document.getElementById('paymentsStatus');
    const searchInput = document.getElementById('searchPayments');
    const filterStatus = document.getElementById('filterStatus');
    const filterCurrency = document.getElementById('filterCurrency');
    const filterStartDate = document.getElementById('filterStartDate');
    const filterEndDate = document.getElementById('filterEndDate');
    const chartPeriod = document.getElementById('chartPeriod');

    // Event listeners
    searchInput.addEventListener('input', filterPayments);
    filterStatus.addEventListener('change', filterPayments);
    filterCurrency.addEventListener('change', filterPayments);
    filterStartDate.addEventListener('change', filterPayments);
    filterEndDate.addEventListener('change', filterPayments);
    chartPeriod.addEventListener('change', updateChart);

    // Load payments on page load
    loadPayments();

    async function loadPayments() {
      paymentsStatus.textContent = 'Loading payments...';
      paymentsStatus.className = 'status';
      
      try {
        const res = await fetch('/api/admin/payments');
        const items = await res.json();
        
        if (!res.ok) throw new Error(items.error || 'Failed to load payments');
        
        payments = items;
        filteredPayments = [...payments];
        renderPayments();
        updateStats();
        updateChart();
        paymentsStatus.textContent = '';
        
      } catch(err) {
        paymentsStatus.textContent = `❌ ${err.message}`;
        paymentsStatus.className = 'status error';
      }
    }

    function renderPayments() {
      if (filteredPayments.length === 0) {
        paymentsTableBody.innerHTML = '<tr><td colspan="6" class="text-center">No payments found</td></tr>';
        return;
      }

      paymentsTableBody.innerHTML = filteredPayments.map(p => `
        <tr>
          <td>
            <div class="customer-info">
              <strong>${p.name || 'N/A'}</strong><br>
              <small>${p.email || 'N/A'}</small>
            </div>
          </td>
          <td>${p.projectRef || 'N/A'}</td>
          <td>
            <div class="amount-info">
              <strong>${formatCurrency(p.agreed || p.depositAmount, p.currency)}</strong>
              ${p.depositAmount && p.agreed && p.depositAmount !== p.agreed ? 
                `<br><small>Deposit: ${formatCurrency(p.depositAmount, p.currency)}</small>` : ''}
            </div>
          </td>
          <td><span class="status-badge ${p.status.toLowerCase()}">${p.status}</span></td>
          <td>${formatDate(p.dateCreated)}</td>
          <td>
            <button onclick="viewPayment(${p.id})" class="btn btn-secondary btn-sm">👁️ View</button>
            <button onclick="deletePayment(${p.id})" class="btn del btn-sm">🗑️ Delete</button>
          </td>
        </tr>
      `).join('');
    }

    function filterPayments() {
      const searchTerm = searchInput.value.toLowerCase();
      const statusFilter = filterStatus.value;
      const currencyFilter = filterCurrency.value;
      const startDate = filterStartDate.value;
      const endDate = filterEndDate.value;
      
      filteredPayments = payments.filter(payment => {
        const matchesSearch = (payment.name && payment.name.toLowerCase().includes(searchTerm)) || 
                            (payment.email && payment.email.toLowerCase().includes(searchTerm)) ||
                            (payment.projectRef && payment.projectRef.toLowerCase().includes(searchTerm));
        const matchesStatus = !statusFilter || payment.status.toLowerCase() === statusFilter;
        const matchesCurrency = !currencyFilter || payment.currency.toLowerCase() === currencyFilter;
        const matchesDate = filterByDateRange(payment.dateCreated, startDate, endDate);
        
        return matchesSearch && matchesStatus && matchesCurrency && matchesDate;
      });
      
      renderPayments();
    }

    function filterByDateRange(dateString, startDate, endDate) {
      if (!startDate && !endDate) return true;
      
      const paymentDate = new Date(dateString);
      const start = startDate ? new Date(startDate) : null;
      const end = endDate ? new Date(endDate) : null;
      
      if (start && end) {
        return paymentDate >= start && paymentDate <= end;
      } else if (start) {
        return paymentDate >= start;
      } else if (end) {
        return paymentDate <= end;
      }
      
      return true;
    }

    function updateStats() {
      const total = payments.reduce((sum, p) => sum + (parseFloat(p.agreed || p.depositAmount) || 0), 0);
      const now = new Date();
      const thisMonth = payments
        .filter(p => {
          const date = new Date(p.dateCreated);
          return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
        })
        .reduce((sum, p) => sum + (parseFloat(p.agreed || p.depositAmount) || 0), 0);
      
      const pending = payments.filter(p => p.status.toLowerCase() === 'pending').length;
      const successful = payments.filter(p => p.status.toLowerCase() === 'succeeded').length;
      
      document.getElementById('totalRevenue').textContent = formatCurrency(total, 'USD');
      document.getElementById('monthlyRevenue').textContent = formatCurrency(thisMonth, 'USD');
      document.getElementById('pendingPayments').textContent = pending;
      document.getElementById('successfulPayments').textContent = successful;
    }

    function updateChart() {
      const period = parseInt(chartPeriod.value);
      const now = new Date();
      const startDate = new Date(now.getTime() - period * 24 * 60 * 60 * 1000);
      
      // Filter payments by period
      const periodPayments = payments.filter(p => {
        const paymentDate = new Date(p.dateCreated);
        return paymentDate >= startDate && paymentDate <= now;
      });
      
      // Group by date and calculate daily revenue
      const dailyRevenue = {};
      for (let d = new Date(startDate); d <= now; d.setDate(d.getDate() + 1)) {
        const dateKey = d.toISOString().split('T')[0];
        dailyRevenue[dateKey] = 0;
      }
      
      periodPayments.forEach(p => {
        const dateKey = new Date(p.dateCreated).toISOString().split('T')[0];
        dailyRevenue[dateKey] += parseFloat(p.agreed || p.depositAmount) || 0;
      });
      
      // Update chart placeholder with data
      const chartContainer = document.getElementById('revenueChart');
      const totalRevenue = Object.values(dailyRevenue).reduce((sum, val) => sum + val, 0);
      const avgDaily = totalRevenue / Object.keys(dailyRevenue).length;
      
      chartContainer.innerHTML = `
        <div class="chart-data">
          <div class="chart-summary">
            <div class="summary-item">
              <strong>Total Revenue:</strong> ${formatCurrency(totalRevenue, 'USD')}
            </div>
            <div class="summary-item">
              <strong>Average Daily:</strong> ${formatCurrency(avgDaily, 'USD')}
            </div>
            <div class="summary-item">
              <strong>Transactions:</strong> ${periodPayments.length}
            </div>
          </div>
          <div class="chart-bars">
            ${Object.entries(dailyRevenue).map(([date, revenue]) => `
              <div class="chart-bar" style="height: ${Math.max(20, (revenue / Math.max(...Object.values(dailyRevenue))) * 100)}px">
                <div class="bar-tooltip">
                  ${new Date(date).toLocaleDateString()}: ${formatCurrency(revenue, 'USD')}
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function viewPayment(id) {
      const payment = payments.find(p => p.id === id);
      if (!payment) return;
      
      document.getElementById('modalTitle').textContent = `Payment #${payment.id}`;
      document.getElementById('modalContent').innerHTML = `
        <div class="payment-details">
          <div class="detail-row">
            <strong>Customer:</strong> ${payment.name || 'N/A'}
          </div>
          <div class="detail-row">
            <strong>Email:</strong> <a href="mailto:${payment.email}">${payment.email || 'N/A'}</a>
          </div>
          <div class="detail-row">
            <strong>Project:</strong> ${payment.projectRef || 'N/A'}
          </div>
          <div class="detail-row">
            <strong>Agreed Amount:</strong> ${formatCurrency(payment.agreed, payment.currency)}
          </div>
          <div class="detail-row">
            <strong>Deposit Amount:</strong> ${formatCurrency(payment.depositAmount, payment.currency)}
          </div>
          <div class="detail-row">
            <strong>Currency:</strong> ${payment.currency.toUpperCase()}
          </div>
          <div class="detail-row">
            <strong>Status:</strong> <span class="status-badge ${payment.status.toLowerCase()}">${payment.status}</span>
          </div>
          <div class="detail-row">
            <strong>Stripe ID:</strong> <code>${payment.stripePaymentIntentId}</code>
          </div>
          <div class="detail-row">
            <strong>Date Created:</strong> ${formatDate(payment.dateCreated)}
          </div>
        </div>
      `;
      
      document.getElementById('paymentModal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('paymentModal').style.display = 'none';
    }

    function refundPayment() {
      // Note: This would require a refund endpoint
      alert('Refund functionality would be implemented here');
    }

    async function deletePayment(id) {
      if (!confirm('Are you sure you want to delete this payment record?')) return;
      
      try {
        // Note: This would require a DELETE endpoint for payments
        payments = payments.filter(p => p.id !== id);
        filteredPayments = filteredPayments.filter(p => p.id !== id);
        renderPayments();
        updateStats();
        updateChart();
        
        paymentsStatus.textContent = '✅ Payment deleted successfully!';
        paymentsStatus.className = 'status success';
        setTimeout(() => {
          paymentsStatus.textContent = '';
          paymentsStatus.className = 'status';
        }, 3000);
        
      } catch(err) {
        paymentsStatus.textContent = `❌ ${err.message}`;
        paymentsStatus.className = 'status error';
      }
    }

    function exportPayments() {
      const csvContent = "data:text/csv;charset=utf-8," + 
        "ID,Name,Email,Project,Agreed Amount,Deposit Amount,Currency,Status,Date Created\n" +
        payments.map(p => `${p.id},${p.name || ''},${p.email || ''},${p.projectRef || ''},${p.agreed || ''},${p.depositAmount || ''},${p.currency},${p.status},${p.dateCreated}`).join("\n");
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "payments.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function clearFilters() {
      searchInput.value = '';
      filterStatus.value = '';
      filterCurrency.value = '';
      filterStartDate.value = '';
      filterEndDate.value = '';
      filterPayments();
    }

    function formatCurrency(amount, currency) {
      if (!amount) return 'N/A';
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: currency.toUpperCase()
      }).format(amount);
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    // Close modal when clicking outside
    document.getElementById('paymentModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeModal();
      }
    });
  </script>
</body>
</html>
